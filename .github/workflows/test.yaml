name: secrets test

on:
  pull_request:
    branches: [ main ]

jobs:
  test:
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/stv-io/tg-gcp-ci-tools-image/tg-gcp-ci-tools-image:v0.1.2
      options: --user root # https://github.com/actions/checkout/issues/1014
    steps:
      - uses: 'actions/checkout@v3'
      - name: test
        env:
          GIT_SSH_COMMAND: "echo '${{ secrets.SSH_PRIVATE_KEY }}' | base64 -d > id_rsa
            && ssh-keyscan github.com > known_hosts
            && chmod 600 id_rsa known_hosts
            && ssh -i ./id_rsa -o UserKnownHostsFile=./known_hosts"
        run: | 
          echo $GIT_SSH_COMMAND
          ls -ltrha ./id_rsa
          ls -ltrha ./known_hosts
